name: CI/CD Pipeline

on:
  push:
  pull_request:

permissions:
  contents: write
  packages: write

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests (cyclo)
        id: test-cyclo
        run: make test-cyclo 2>&1 | tee test-cyclo.log
        continue-on-error: true

      - name: Run tests (misspell)
        id: test-misspell
        run: make test-misspell 2>&1 | tee test-misspell.log
        continue-on-error: true

      - name: Run tests (go test)
        id: test-go
        run: make test-go 2>&1 | tee test-go.log
        continue-on-error: true

      - name: Generate coverage reports
        if: always()
        run: make cover

      - name: Start registry server
        run: |
          go run ./cmd/simple-registry serve \
            -datadir /tmp/registry \
            -adminname admin \
            -adminpwd testpassword123 \
            > /tmp/registry.log 2>&1 &

          echo $! > /tmp/registry.pid

          echo "Waiting for registry to be ready..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -u admin:testpassword123 -sf http://localhost:5000/v2/ >/dev/null 2>&1; then
              echo "âœ… Registry is ready!"
              break
            fi
            attempt=$((attempt + 1))
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ Registry failed to start after $max_attempts attempts"
              echo "=== Registry Logs ==="
              cat /tmp/registry.log
              exit 1
            fi
            echo "  Attempt $attempt/$max_attempts..."
            sleep 1
          done

      - name: Run OCI Distribution Spec conformance tests
        id: test-oci
        continue-on-error: true
        uses: opencontainers/distribution-spec@v1.1.1
        env:
          OCI_ROOT_URL: http://localhost:5000
          OCI_USERNAME: admin
          OCI_PASSWORD: testpassword123
          OCI_NAMESPACE: library/conformance-test
          OCI_CROSSMOUNT_NAMESPACE: myorg/other
          OCI_TEST_PULL: 1
          OCI_TEST_PUSH: 1
          OCI_TEST_CONTENT_DISCOVERY: 1
          OCI_TEST_CONTENT_MANAGEMENT: 1
          OCI_HIDE_SKIPPED_WORKFLOWS: 0
          OCI_DEBUG: 0

      - name: Stop registry server
        if: always()
        run: |
          if [ -f /tmp/registry.pid ]; then
            kill $(cat /tmp/registry.pid) || true
          fi

      - name: Parse conformance test results
        if: always()
        id: oci-results
        run: |
          set -e

          # Parse the HTML report generated by the OCI conformance tests
          # The report contains a summary in the format: "74 passed" and "5 skipped"

          PASSED=$(grep -oP '\d+(?= passed)' report.html 2>/dev/null || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' report.html 2>/dev/null || echo "0")
          SKIPPED=$(grep -oP '\d+(?= skipped)' report.html 2>/dev/null || echo "0")

          # Calculate totals
          RAN_SPECS=$((PASSED + FAILED))
          TOTAL_SPECS=$((RAN_SPECS + SKIPPED))

          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED}" >> $GITHUB_OUTPUT
          echo "skipped=${SKIPPED}" >> $GITHUB_OUTPUT
          echo "ran_specs=${RAN_SPECS}" >> $GITHUB_OUTPUT
          echo "total_specs=${TOTAL_SPECS}" >> $GITHUB_OUTPUT

          echo "âœ… Parsed results from report.html"
          echo "Results: ${PASSED} passed, ${FAILED} failed, ${SKIPPED} skipped"

      - name: Generate test summary
        if: always()
        run: |
          echo "| Status | Test |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY

          # Cyclo test
          if [ "${{ steps.test-cyclo.outcome }}" == "success" ]; then
            echo "| âœ… Passed | **Cyclomatic Complexity** - No functions with complexity > 15 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Failed | **Cyclomatic Complexity** - Some functions have high complexity |" >> $GITHUB_STEP_SUMMARY
          fi

          # Misspell test
          if [ "${{ steps.test-misspell.outcome }}" == "success" ]; then
            echo "| âœ… Passed | **Spell Checking** - No spelling errors found |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Failed | **Spell Checking** - Spelling errors detected |" >> $GITHUB_STEP_SUMMARY
          fi

          # Go test
          if [ "${{ steps.test-go.outcome }}" == "success" ]; then
            echo "| âœ… Passed | **Unit Tests** - All unit tests successful |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Failed | **Unit Tests** - Some unit tests failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # OCI Distribution Spec conformance test
          if [ "${{ steps.oci-results.outputs.failed }}" == "0" ]; then
            echo "| âœ… Passed | **OCI Distribution Spec Conformance** - ${{ steps.oci-results.outputs.passed }} passed, ${{ steps.oci-results.outputs.skipped }} skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Failed | **OCI Distribution Spec Conformance** - ${{ steps.oci-results.outputs.passed }} passed, ${{ steps.oci-results.outputs.skipped }} skipped, ${{ steps.oci-results.outputs.failed }} failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.test-cyclo.outcome }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Cyclomatic Complexity Report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-cyclo.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.test-misspell.outcome }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Spell Checking Report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-misspell.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.test-go.outcome }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Unit Tests Report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-go.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Display coverage summary
        if: always()
        run: |
          if [ -f build/cover.txt ]; then
            COVERAGE=$(grep "total:" build/cover.txt | awk '{print $3}')
            if [ -n "$COVERAGE" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Total Coverage: $COVERAGE**" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Coverage Report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat build/cover.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Display registry logs
        if: always()
        run: |
          if [ -f /tmp/registry.log ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Registry Logs</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/registry.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-${{ github.sha }}
          path: |
            test-cyclo.log
            test-misspell.log
            test-go.log
            build/cover.out
            build/cover.txt
            build/cover.html
          retention-days: 30
          if-no-files-found: ignore

      - name: Check if all tests passed
        if: always()
        run: |
          FAILED=0

          if [ "${{ steps.test-cyclo.outcome }}" != "success" ]; then
            echo "âŒ Cyclomatic complexity test failed"
            FAILED=1
          fi

          if [ "${{ steps.test-misspell.outcome }}" != "success" ]; then
            echo "âŒ Misspell test failed"
            FAILED=1
          fi

          if [ "${{ steps.test-go.outcome }}" != "success" ]; then
            echo "âŒ Go unit tests failed"
            FAILED=1
          fi

          if [ "${{ steps.test-oci.outcome }}" != "success" ]; then
            echo "âŒ OCI Distribution Spec Conformance test failed"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "One or more tests failed. Check the summary above for details."
            exit 1
          else
            echo "âœ… All tests passed successfully!"
          fi

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      - tests
    if: |
      github.ref_type == 'tag' &&
      github.event.base_ref == 'refs/heads/master'
    steps:
      - name: Validate version tag format
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "Expected format: vX.Y.Z (e.g., v1.2.3)"
            exit 1
          fi
          echo "âœ… Valid version tag: $TAG_NAME"

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Build artifacts
        id: build
        run: |
          echo "Building release artifacts..."
          make artifacts

          # Get version from tag
          VERSION="${{ github.ref_name }}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Count artifacts
          TAR_COUNT=$(ls -1 build/simple-registry_*.tar.gz 2>/dev/null | wc -l)
          echo "tar_count=${TAR_COUNT}" >> $GITHUB_OUTPUT

      - name: Generate build summary
        if: always()
        run: |
          echo "## Version Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`master\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "## âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Generated Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List tar.gz files
            if ls build/simple-registry_*.tar.gz 1> /dev/null 2>&1; then
              echo "**Archives (.tar.gz):**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              ls -lh build/simple-registry_*.tar.gz | awk '{print $9, "(" $5 ")"}' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # List checksum files
            if ls build/simple-registry_*.sha256 1> /dev/null 2>&1; then
              echo "**Checksums (.sha256):**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              ls -lh build/simple-registry_*.sha256 | awk '{print $9, "(" $5 ")"}' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Show checksums content
            if [ -f "build/simple-registry_${{ steps.build.outputs.version }}.sha256" ]; then
              echo "### Checksums" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat "build/simple-registry_${{ steps.build.outputs.version }}.sha256" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The artifact build process failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-artifacts
          path: |
            build/simple-registry_*.tar.gz
            build/simple-registry_*.sha256
          if-no-files-found: error

      - name: Create Release
        id: create-release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/simple-registry_*.tar.gz
            build/simple-registry_*.sha256
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Generate release summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.create-release.outcome }}" == "success" ]; then
            echo "## ðŸš€ Release Published Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Release URL:** ${{ steps.create-release.outputs.url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Installation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download the appropriate binary for your platform:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# Linux AMD64" >> $GITHUB_STEP_SUMMARY
            echo "curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/simple-registry_${{ steps.build.outputs.version }}_linux-amd64.tar.gz | tar -xz simple-registry" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Linux ARM64" >> $GITHUB_STEP_SUMMARY
            echo "curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/simple-registry_${{ steps.build.outputs.version }}_linux-arm64.tar.gz | tar -xz simple-registry" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Verify Checksums" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/simple-registry_${{ steps.build.outputs.version }}.sha256 | sha256sum --ignore-missing -c -" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Release Publication Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The release could not be published. Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
