name: CI/CD Pipeline

on:
  push:
  pull_request:

permissions:
  contents: write
  packages: write

jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests (cyclo)
        id: test-cyclo
        run: make test-cyclo 2>&1 | tee test-cyclo.log
        continue-on-error: true

      - name: Run tests (misspell)
        id: test-misspell
        run: make test-misspell 2>&1 | tee test-misspell.log
        continue-on-error: true

      - name: Run tests (go test)
        id: test-go
        run: make test-go 2>&1 | tee test-go.log
        continue-on-error: true

      - name: Generate coverage reports
        if: always()
        run: make cover

      - name: Generate test summary
        if: always()
        run: |
          echo "# Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Cyclo test
          echo "## Cyclomatic Complexity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-cyclo.outcome }}" == "success" ]; then
            echo "✅ **Passed** - No functions with complexity > 15" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Failed** - Some functions have high complexity" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-cyclo.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Misspell test
          echo "## Spell Checking" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-misspell.outcome }}" == "success" ]; then
            echo "✅ **Passed** - No spelling errors found" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Failed** - Spelling errors detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-misspell.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Go test
          echo "## Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-go.outcome }}" == "success" ]; then
            echo "✅ **Passed** - All unit tests successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Failed** - Some unit tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-go.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Display coverage summary
        if: always()
        run: |
          if [ -f build/cover.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat build/cover.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            COVERAGE=$(grep "total:" build/cover.txt | awk '{print $3}')
            if [ -n "$COVERAGE" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Total Coverage: $COVERAGE**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-${{ github.sha }}
          path: |
            test-cyclo.log
            test-misspell.log
            test-go.log
            build/cover.out
            build/cover.txt
            build/cover.html
          retention-days: 30
          if-no-files-found: ignore

      - name: Check if all tests passed
        if: always()
        run: |
          FAILED=0

          if [ "${{ steps.test-cyclo.outcome }}" != "success" ]; then
            echo "❌ Cyclomatic complexity test failed"
            FAILED=1
          fi

          if [ "${{ steps.test-misspell.outcome }}" != "success" ]; then
            echo "❌ Misspell test failed"
            FAILED=1
          fi

          if [ "${{ steps.test-go.outcome }}" != "success" ]; then
            echo "❌ Go unit tests failed"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "One or more tests failed. Check the summary above for details."
            exit 1
          else
            echo "✅ All tests passed successfully!"
          fi

  oci-distribution-conformance:
    name: OCI Distribution Conformance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build binary
        run: go build -o simple-registry ./cmd/simple-registry

      - name: Start registry server
        run: |
          ./simple-registry serve \
            -datadir /tmp/registry \
            -adminname admin \
            -adminpwd testpassword123 \
            > /tmp/registry.log 2>&1 &

          echo $! > /tmp/registry.pid

          echo "Waiting for registry to be ready..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -u admin:testpassword123 -sf http://localhost:5000/v2/ >/dev/null 2>&1; then
              echo "✅ Registry is ready!"
              break
            fi
            attempt=$((attempt + 1))
            if [ $attempt -eq $max_attempts ]; then
              echo "❌ Registry failed to start after $max_attempts attempts"
              echo "=== Registry Logs ==="
              cat /tmp/registry.log
              exit 1
            fi
            echo "  Attempt $attempt/$max_attempts..."
            sleep 1
          done

      - name: Run OCI Distribution Spec conformance tests
        uses: opencontainers/distribution-spec@v1.1.1
        env:
          OCI_ROOT_URL: http://localhost:5000
          OCI_USERNAME: admin
          OCI_PASSWORD: testpassword123
          OCI_NAMESPACE: library/conformance-test
          OCI_CROSSMOUNT_NAMESPACE: myorg/other
          OCI_TEST_PULL: 1
          OCI_TEST_PUSH: 1
          OCI_TEST_CONTENT_DISCOVERY: 1
          OCI_TEST_CONTENT_MANAGEMENT: 1
          OCI_HIDE_SKIPPED_WORKFLOWS: 0
          OCI_DEBUG: 0

      - name: Show registry logs on failure
        if: failure()
        run: |
          echo "=== Registry Logs ==="
          cat /tmp/registry.log

      - name: Stop registry server
        if: always()
        run: |
          if [ -f /tmp/registry.pid ]; then
            kill $(cat /tmp/registry.pid) || true
          fi

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      - tests
      - oci-distribution-conformance
    if: |
      github.ref_type == 'tag' &&
      github.event.base_ref == 'refs/heads/master'
    steps:
      - name: Validate version tag format
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid tag format: $TAG_NAME"
            echo "Expected format: vX.Y.Z (e.g., v1.2.3)"
            exit 1
          fi
          echo "✅ Valid version tag: $TAG_NAME"

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Build artifacts
        run: make artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-artifacts
          path: |
            build/simple-registry_*.tar.gz
            build/simple-registry_*.sha256
          if-no-files-found: error

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/simple-registry_*.tar.gz
            build/simple-registry_*.sha256
          generate_release_notes: true
          draft: false
          prerelease: false
