name: oci-distribution-conformance
on: push
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: true
          fetch-tags: true

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Start registry server
        run: |
          go run ./cmd/simple-registry serve \
            -datadir /tmp/registry \
            -adminname admin \
            -adminpwd testpassword123 \
            2>&1 >/tmp/registry.log &

          echo $! > /tmp/registry.pid

          echo "Waiting for registry to be ready..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -u admin:testpassword123 -sf http://localhost:5000/v2/ 2>&1 >/dev/null; then
              echo "✓ Registry is ready!"
              break
            fi
            attempt=$((attempt + 1))
            if [ $attempt -eq $max_attempts ]; then
              echo "✗ Registry failed to start after $max_attempts attempts"
              echo "=== Registry Logs ==="
              cat /tmp/registry.log
              exit 1
            fi
            echo "  Attempt $attempt/$max_attempts..."
            sleep 1
          done

      - name: Run OCI Distribution Spec conformance tests
        uses: opencontainers/distribution-spec@v1.1.1
        env:
          OCI_ROOT_URL: http://localhost:5000
          OCI_NAMESPACE: library/conformance-test
          OCI_USERNAME: admin
          OCI_PASSWORD: testpassword123
          OCI_TEST_PULL: 1
          OCI_TEST_PUSH: 1
          OCI_TEST_CONTENT_DISCOVERY: 1
          OCI_TEST_CONTENT_MANAGEMENT: 1
          OCI_HIDE_SKIPPED_WORKFLOWS: 0
          OCI_DEBUG: 0
          OCI_DELETE_MANIFEST_BEFORE_BLOBS: 0

      - name: Show registry logs on failure
        if: failure()
        run: |
          echo "=== Registry Logs ==="
          cat /tmp/registry.log

      - name: Stop registry server
        if: always()
        run: |
          if [ -f /tmp/registry.pid ]; then
            kill $(cat /tmp/registry.pid) || true
          fi
